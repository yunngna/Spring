<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
       layout:decorate="~{layouts/layout}">
<head>
<meta charset="UTF-8">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<title>Insert title here</title>
<script>
//화면이 구성 되기 전에 미리 dom 생성
	const bno = [[${board.bno}]];
	window.addEventListener("DOMContentLoaded", function(){
		getReply(); //댓글 목록 가져오기 
		delReply(); //삭제 이벤트 로딩
	});
	
	//댓글 삭제 이벤트 -> 삭제 호출 
	function delReply(){
		document.querySelector(".replys").addEventListener("click",function(){
			//event = 전역변수
			if(window.event.target.classList.contains("btnReplyDel")){
				//class 중 btnReplyDel 인 경우에만 실행 
				const div = event.target.closest(".row"); // 지울 대상 (버튼을 포함하는 부모태그)
				const rno = event.target.dataset.rno; //삭제할 댓글 번호
				const url = `/replies/${rno}` 
				//서버에 삭제 요청
				fetch(url,{method:"delete"})
				.then(result => result.text()) //서버로 부터 넘어오는 게 json 인지 string 인지 control에서 확인 == string (text)
				.then(result => div.remove()) //result= "success" 이며 결과가 넘어오면 화면에서 지우기
			}
			
		})
		
	}
	
	//댓글 삭제 결과 처리 
	
	
	//댓글 가져오기 (ajax 호출)
	function getReply(){
		const url = `/replies/pages/${bno}/1`
		fetch(url)
		.then(result=>result.json())
		.then(result=>getReplyProc(result))
	}
	
	
	//댓글 결과 처리  
	function getReplyProc(result){
		//replys 에 댓글 들어가게 하기
		const replys= document.querySelector(".replys");
		result.list.forEach(reply => {
			//data-rno="${reply.rno}"   => 데이터를 저장 해준다. (댓글번호rno을 저장해준다.)
			const html = `<div class="row">
				              <div class="col-6">${reply.reply}</div>
				              <div class="col-3">${reply.replyer}</div>
				              <div class="col-3"><button type="button" 
				                                   data-rno="${reply.rno}"  
				                                   class="btn btn-danger mb-2 btnReplyDel">삭제</button>
				              </div>
			              </div>`;
			replys.insertAdjacentHTML("beforeend",html)
		});
	}
	
	
</script>
</head>
<body>
<div class="container" layout:fragment="content">
	<table class="table">
		<tr><th>번호</th><td th:text="${board.bno}"></td></tr>
		<tr><th>제목</th><td th:text="${board.title}"></td></tr>
		<tr><th>내용</th><td th:text="${board.content}"></td></tr>
		<tr><th>작성자</th><td th:text="${board.writer}"></td></tr>
		<tr><th>작성일자</th><td th:text="${board.regdate}"></td></tr>
	</table>
	<button th:onclick="|location.href='modify?bno=${board.bno}'|">수정</button>
	<button th:onclick="|location.href='remove?bno=${board.bno}'|">삭제</button>
	
	<!-- 댓글 -->
	<div class="card">
		<div class="card-header">댓글</div>
		<div class="card-body replys"></div>
	</div>
</div>

</body>
</html>